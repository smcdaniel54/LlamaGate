name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            binary_name: llamagate-linux-amd64
            go-version: '1.24'
          - os: windows-latest
            goos: windows
            goarch: amd64
            binary_name: llamagate-windows-amd64.exe
            go-version: '1.24'
          - os: macos-latest
            goos: darwin
            goarch: amd64
            binary_name: llamagate-darwin-amd64
            go-version: '1.24'
          - os: macos-latest
            goos: darwin
            goarch: arm64
            binary_name: llamagate-darwin-arm64
            go-version: '1.24'
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: ${{ matrix.go-version }}
        cache-dependency-path: go.sum
    
    - name: Download dependencies
      run: go mod download
    
    - name: Clean up coverage files
      run: |
        rm -f coverage.out 2>/dev/null || true
        rm -rf coverage .out 2>/dev/null || true
      shell: bash
    
    - name: Run tests
      timeout-minutes: 10
      shell: bash
      run: |
        PACKAGES=$(go list ./... 2>/dev/null | grep -v "^\.out$" || go list ./...)
        if [ -z "$PACKAGES" ]; then
          PACKAGES=$(go list ./...)
        fi
        go test -coverprofile=coverage.out -covermode=atomic -timeout=5m $PACKAGES
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v5
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      shell: bash
      run: go build -o ${{ matrix.binary_name }} ./cmd/llamagate
    
    - name: Verify binary (Linux/macOS)
      if: matrix.goos != 'windows'
      run: |
        chmod +x ${{ matrix.binary_name }}
        file ${{ matrix.binary_name }}
        # Verify binary is executable and not empty
        test -f ${{ matrix.binary_name }} && test -s ${{ matrix.binary_name }} && echo "Binary verification passed"
    
    - name: Verify binary (Windows)
      if: matrix.goos == 'windows'
      shell: pwsh
      run: |
        $binary = Get-Item ${{ matrix.binary_name }}
        if ($binary.Length -gt 0) {
          Write-Host "Binary verification passed: $($binary.Name) ($($binary.Length) bytes)"
        } else {
          Write-Error "Binary is empty or missing"
          exit 1
        }

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24'
    
    - name: Download dependencies
      run: go mod download
    
    - name: Run golangci-lint
      uses: golangci/golangci-lint-action@v8
      with:
        version: v2.8.0
        # Focus on production code - test files excluded via .golangci.yml skip-files
        # Developers should still run full linting locally
        args: --timeout=10m --verbose
      timeout-minutes: 15

  test-installers:
    name: Test Installers
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            installer_type: unix
          - os: windows-latest
            installer_type: windows
    
    steps:
    - uses: actions/checkout@v6
    
    - name: Test Unix Installer
      if: matrix.installer_type == 'unix'
      run: |
        chmod +x tests/installer/test-installer-unix.sh
        ./tests/installer/test-installer-unix.sh
    
    - name: Test Windows Installer
      if: matrix.installer_type == 'windows'
      shell: pwsh
      run: |
        .\tests\installer\test-installer-windows.ps1
    
    - name: Test One-Liners
      if: matrix.installer_type == 'windows'
      shell: pwsh
      run: |
        .\tests\installer\test-one-liners.ps1

  security:
    name: Security Scan
    # Run security scans on main branch and PRs, but make it non-blocking for speed
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24'
    
    - name: Run Gosec Security Scanner
      uses: securego/gosec@master
      with:
        args: '-no-fail -fmt json -out gosec-report.json ./...'
    
    - name: Upload Gosec results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: gosec-report
        path: gosec-report.json
        retention-days: 7
    
    - name: Run govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./...

  # Race detector tests - run only on main branch to avoid CI slowdowns
  # Developers should run these locally: go test -race ./...
  # This job is non-blocking - failures won't prevent merges
  test-race:
    name: Test (Race Detector)
    # Only run on main branch merges, not on every PR to speed up CI
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
    - uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.24'
        cache-dependency-path: go.sum
    
    - name: Download dependencies
      run: go mod download
    
    - name: Run tests with race detector
      timeout-minutes: 20
      env:
        CGO_ENABLED: 1
      run: |
        PACKAGES=$(go list ./... 2>/dev/null | grep -v "^\.out$" || go list ./...)
        if [ -z "$PACKAGES" ]; then
          PACKAGES=$(go list ./...)
        fi
        go test -race -timeout=10m $PACKAGES
